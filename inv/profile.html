<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Epistecnología</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/hFRyKrxY/logo-epist-v3-1x1-c.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        /* CSS COMPLETO Y VERIFICADO */
        :root {
            --color-background: #f0f2f5; --color-surface: #ffffff; --color-text-primary: #1c1e21;
            --color-text-secondary: #65676b; --color-accent: #b72a1e; --color-primary-cta: #1877f2;
            --color-success: #28a745; --color-error: #dc3545; --color-border: #ddd;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.08); --border-radius: 8px;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--color-background); }
        .page-container { display: flex; justify-content: center; align-items: flex-start; padding: 3rem 1.5rem; min-height: 100vh; box-sizing: border-box;}
        .profile-content { width: 100%; max-width: 900px; }
        .profile-header { text-align: center; margin-bottom: 2rem; }
        .profile-header img { height: 40px; margin-bottom: 1rem; }
        .profile-header h1 { margin: 0 0 0.5rem 0; color: var(--color-text-primary); }
        .profile-header p { color: var(--color-text-secondary); margin: 0; }
        .profile-layout { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 900px) { .profile-layout { grid-template-columns: 320px 1fr; } }
        .profile-card, .profile-form-container { background-color: var(--color-surface); padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-light); }
        .profile-card { text-align: center; }
        .profile-card__avatar-wrapper { margin: 0 auto 1rem auto; width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--color-accent); padding: 5px; }
        .profile-card__avatar-wrapper img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .profile-card h2 { margin: 0 0 0.5rem 0; font-size: 1.5rem; color: var(--color-text-primary); }
        .profile-card__bio { color: var(--color-text-secondary); font-style: italic; min-height: 4.5em; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--color-text-primary); }
        .form-group input, .form-group textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-family: inherit; font-size: 1rem; box-sizing: border-box; }
        .form-message { min-height: 1.2em; margin-top: 1rem; font-weight: 500; }
        .form-message.success { color: var(--color-success); } .form-message.error { color: var(--color-error); }
        .btn-primary { background-color: var(--color-primary-cta); color: white; padding: 0.8rem 1.5rem; border-radius: var(--border-radius); font-weight: 600; font-size: 1rem; cursor: pointer; border: none; text-decoration: none; display: inline-flex; justify-content: center; align-items: center; gap: 0.5rem; transition: background-color 0.2s ease; }
        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-primary.is-disabled { background-color: #a5b4c8; color: #e9ecef; cursor: not-allowed; pointer-events: none; }
        .dashboard-link-wrapper { margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--color-border); text-align: center; }
    </style>
</head>
<body>

    <div class="page-container">
        <div class="profile-content">
            <header class="profile-header">
                <a href="/"><img src="https://i.ibb.co/hFRyKrxY/logo-epist-v3-1x1-c.png" alt="Logo Epistecnología"></a>
                <h1>Configura tu Perfil Público</h1>
                <p>Esta información es esencial para acceder a las herramientas de creación.</p>
            </header>

            <div class="profile-layout">
                <div class="profile-card">
                    <div class="profile-card__avatar-wrapper"><img id="profile-card-avatar" alt="Avatar de usuario"></div>
                    <h2 id="profile-card-name">Cargando...</h2>
                    <p id="profile-card-bio"></p>
                </div>
                <div class="profile-form-container">
                    <h3>Completa tus datos</h3>
                    <form id="profile-form">
                        <div class="form-group"><label for="display-name">Nombre a Mostrar</label><input type="text" id="display-name" placeholder="Ej: Dra. Ada Lovelace" required></div>
                        <div class="form-group"><label for="bio">Biografía Corta (máx. 150 caracteres)</label><textarea id="bio" rows="3" placeholder="Ej: Científica de datos y especialista en comunicación..." maxlength="150"></textarea></div>
                        <div class="form-group"><label for="orcid-url">URL de tu Perfil ORCID</label><input type="url" id="orcid-url" placeholder="https://orcid.org/0000-0000-0000-0000" required></div>
                        <hr>
                        <h4>Perfiles Sociales (Opcional)</h4>
                        <div class="form-group"><label for="website-url">Sitio Web o Blog</label><input type="url" id="website-url" placeholder="https://ejemplo.com"></div>
                        <div class="form-group"><label for="linkedin-url">Perfil de LinkedIn</label><input type="url" id="linkedin-url" placeholder="https://linkedin.com/in/usuario"></div>
                        <div class="form-group"><label for="twitter-url">Perfil de X (Twitter)</label><input type="url" id="twitter-url" placeholder="https://x.com/usuario"></div>
                        <button type="submit" class="btn-primary"><span class="btn-text">Guardar Cambios</span></button>
                        <p id="profile-form-message" class="form-message"></p>
                    </form>
                    <div class="dashboard-link-wrapper">
                        <a href="/inv/dashboard.html" id="dashboard-link-btn" class="btn-primary is-disabled"><i class="fa-solid fa-arrow-right"></i> Acceder al Dashboard</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- 1. CONFIGURACIÓN ---
            const SUPABASE_URL = 'https://seyknzlheaxmwztkfxmk.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNleWtuemxoZWF4bXd6dGtmeG1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyNjc5MTQsImV4cCI6MjA2NDg0MzkxNH0.waUUTIWH_p6wqlYVmh40s4ztG84KBPM_Ut4OFF6WC4E';
            // Accedemos a la variable global 'supabase' creada por el script anterior
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // --- 2. LÓGICA DE LA PÁGINA ---
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session || !session.user) {
                alert("Sesión no encontrada. Por favor, inicia sesión de nuevo para continuar.");
                // Opcional: Redirigir si no hay sesión
                // window.location.href = '/login.html'; 
                return;
            }

            const userId = session.user.id;
            const userMetadata = session.user.user_metadata;
            const form = document.getElementById('profile-form');
            const dashboardLink = document.getElementById('dashboard-link-btn');

            const checkDashboardLink = (orcid) => {
                if (orcid && orcid.includes('orcid.org')) {
                    dashboardLink.classList.remove('is-disabled');
                    dashboardLink.title = "¡Listo! Accede al dashboard para empezar a crear.";
                } else {
                    dashboardLink.classList.add('is-disabled');
                    dashboardLink.title = "Debes guardar una URL de ORCID válida para poder continuar.";
                }
            };
            
            const loadProfileData = async () => {
                document.getElementById('profile-card-avatar').src = userMetadata?.avatar_url || 'https://i.ibb.co/61fJv24/default-avatar.png';
                
                // Usaremos Supabase para la base de datos, simplificando todo.
                const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', userId).single();

                if (error && error.code !== 'PGRST116') { // PGRST116: No rows found, lo cual no es un error fatal
                    console.error("Error al cargar perfil de Supabase:", error);
                    alert("Hubo un error al cargar tu perfil. Revisa la consola para más detalles.");
                    return;
                }

                if (data) {
                    document.getElementById('profile-card-name').textContent = data.display_name || userMetadata?.full_name || 'Completa tu perfil';
                    document.getElementById('profile-card-bio').textContent = data.bio || 'Añade tu biografía...';
                    form.querySelector('#display-name').value = data.display_name || '';
                    form.querySelector('#bio').value = data.bio || '';
                    form.querySelector('#orcid-url').value = data.orcid || '';
                    form.querySelector('#website-url').value = data.website || '';
                    form.querySelector('#linkedin-url').value = data.linkedin || '';
                    form.querySelector('#twitter-url').value = data.twitter || '';
                } else {
                    // Si no hay perfil en la DB, rellenar con datos de la sesión
                    document.getElementById('profile-card-name').textContent = userMetadata?.full_name || 'Completa tu perfil';
                    form.querySelector('#display-name').value = userMetadata?.full_name || '';
                }
                checkDashboardLink(form.querySelector('#orcid-url').value);
            };

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveButton = form.querySelector('button[type="submit"]');
                const btnText = saveButton.querySelector('.btn-text');
                const messageEl = document.getElementById('profile-form-message');

                saveButton.disabled = true;
                btnText.textContent = 'Guardando...';

                const updates = {
                    id: userId,
                    updated_at: new Date(),
                    display_name: form.querySelector('#display-name').value,
                    bio: form.querySelector('#bio').value,
                    orcid: form.querySelector('#orcid-url').value,
                    website: form.querySelector('#website-url').value,
                    linkedin: form.querySelector('#linkedin-url').value,
                    twitter: form.querySelector('#twitter-url').value,
                    avatar_url: userMetadata?.avatar_url
                };

                const { error } = await supabaseClient.from('profiles').upsert(updates);
                
                if (error) {
                    messageEl.textContent = `Error: ${error.message}`;
                    messageEl.className = 'form-message error';
                } else {
                    messageEl.textContent = '¡Perfil actualizado!';
                    messageEl.className = 'form-message success';
                    await loadProfileData(); // Recargar para reflejar cambios
                }

                setTimeout(() => {
                    saveButton.disabled = false;
                    btnText.textContent = 'Guardar Cambios';
                    messageEl.textContent = '';
                    messageEl.className = 'form-message';
                }, 2000);
            });

            // Carga inicial de los datos
            await loadProfileData();
        });
    </script>
</body>
</html>