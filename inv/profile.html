<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil y Proyectos - Epistecnología</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/hFRyKrxY/logo-epist-v3-1x1-c.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        /* ==========================================================================
           1. VARIABLES Y ESTILOS GLOBALES
           ========================================================================== */
        :root {
            --color-background: #f0f2f5; 
            --color-surface: #ffffff; 
            --color-text-primary: #1c1e21;
            --color-text-secondary: #65676b; 
            --color-accent: #b72a1e; 
            --color-primary-cta: #1877f2;
            --color-success: #28a745; 
            --color-error: #dc3545; 
            --color-border: #ddd;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.08); 
            --border-radius: 12px;
            --header-height: 70px;
        }

        body.dark-theme {
            --color-background: #18191a;
            --color-surface: #242526;
            --color-text-primary: #e4e6eb;
            --color-text-secondary: #b0b3b8;
            --color-border: #3a3b3c;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            background-color: var(--color-background); 
            color: var(--color-text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3 { margin: 0 0 1rem 0; color: var(--color-text-primary); font-weight: 600; }
        h1 { font-size: 2rem; }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.2rem; color: var(--color-text-secondary); }
        hr { border: none; border-top: 1px solid var(--color-border); margin: 2rem 0; }

        /* ==========================================================================
           2. BARRA DE NAVEGACIÓN SUPERIOR
           ========================================================================== */
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--header-height);
            padding: 0 1.5rem;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--color-border);
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-theme .top-bar {
            background-color: rgba(24, 25, 26, 0.8);
        }
        .top-bar__left { display: flex; align-items: center; gap: 1rem; }
        .top-bar__logo img { height: 32px; display: block; }
        .top-bar__right { display: flex; align-items: center; gap: 0.75rem; }
        .top-bar-btn {
            background: none; border: none; cursor: pointer; color: var(--color-text-secondary);
            width: 40px; height: 40px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 1.1rem;
            transition: background-color 0.2s, color 0.2s;
        }
        .top-bar-btn:hover { background-color: var(--color-border); color: var(--color-text-primary); }
        #user-avatar-header img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        /* ==========================================================================
           3. LAYOUT PRINCIPAL Y BENTO GRID
           ========================================================================== */
        .page-container { 
            display: flex; 
            justify-content: center; 
            padding: 2rem 1.5rem; 
        }
        .profile-content { width: 100%; max-width: 1200px; }
        .profile-header { text-align: center; margin-bottom: 2.5rem; }
        .profile-header p { font-size: 1.1rem; color: var(--color-text-secondary); max-width: 600px; margin: 0.5rem auto 0 auto; }
        
        .bento-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: 1fr;
        }

        .bento-box {
            background-color: var(--color-surface);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            transition: background-color 0.3s;
        }
        
        /* ESTA REGLA AHORA SOLO AFECTA AL ALINEAMIENTO DEL TEXTO */
        .profile-card { text-align: center; }

        /* ==========================================================================
           4. ESTILOS DE COMPONENTES
           ========================================================================== */
        
        /* TARJETA DE PERFIL */
        .profile-card__avatar-wrapper { margin: 0 auto 1rem auto; width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--color-accent); padding: 5px; }
        .profile-card__avatar-wrapper img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .profile-card__bio { color: var(--color-text-secondary); font-style: italic; min-height: 4.5em; margin-bottom: 1rem; }
        .social-links { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; font-size: 1.5rem; }
        .social-links a { color: var(--color-text-secondary); transition: color 0.2s; }
        .social-links a:hover { color: var(--color-accent); }
        .dashboard-link-wrapper { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-border); }
        
        /* FORMULARIO */
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        input, textarea { 
            width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--color-border); 
            border-radius: var(--border-radius); font-family: inherit; font-size: 1rem; 
            box-sizing: border-box; background-color: var(--color-background); color: var(--color-text-primary);
            transition: border-color 0.2s, background-color 0.3s;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--color-accent);
        }
        .input-group { display: flex; gap: 0.5rem; }
        .input-group input { flex-grow: 1; }
        
        /* BOTONES */
        .btn-primary, .btn-secondary {
            padding: 0.8rem 1.5rem; border-radius: var(--border-radius); font-weight: 600; 
            font-size: 1rem; cursor: pointer; border: 1px solid transparent; text-decoration: none; 
            display: inline-flex; justify-content: center; align-items: center; 
            gap: 0.5rem; transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .btn-primary { background-color: var(--color-primary-cta); color: white; }
        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-primary.is-disabled, .btn-primary:disabled { background-color: #a5b4c8; color: #e9ecef; cursor: not-allowed; pointer-events: none; }
        
        .btn-secondary { background-color: var(--color-surface); color: var(--color-text-primary); border-color: var(--color-border); }
        .btn-secondary:hover { background-color: var(--color-background); }
        
        .form-message { min-height: 1.2em; margin-top: 1rem; font-weight: 500; }
        .form-message.success { color: var(--color-success); } 
        .form-message.error { color: var(--color-error); }
        
        /* LISTA DE PROYECTOS */
        #projects-list .project-item { background-color: var(--color-background); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem; border-left: 4px solid var(--color-accent); }
        
        /* MODAL */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 2000; justify-content: center;
            align-items: center; padding: 1rem; box-sizing: border-box;
        }
        .modal-overlay.is-visible { display: flex; }
        .modal { background: var(--color-surface); padding: 2rem; border-radius: var(--border-radius); width: 100%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-close-btn { font-size: 1.5rem; background: none; border: none; cursor: pointer; line-height: 1; color: var(--color-text-primary); }
        .doi-fetcher { display: flex; gap: 0.5rem; }
        .modal-footer { border-top: 1px solid var(--color-border); padding-top: 1.5rem; margin-top: 1.5rem; text-align: right; }

        /* ==========================================================================
           5. REGLAS RESPONSIVAS
           ========================================================================== */
        
        /* --- VISTA DE ESCRITORIO --- */
        @media (min-width: 900px) {
            .bento-grid {
                grid-template-columns: repeat(3, 1fr);
                grid-template-areas:
                    "card form form"
                    "card projects projects";
            }
            
            /* --- INICIO DE LA CORRECCIÓN --- */
            /* Las asignaciones de área AHORA SÓLO existen para la vista de escritorio */
            .profile-card { grid-area: card; }
            .profile-form-container { grid-area: form; }
            .profile-projects-container { grid-area: projects; }
            /* --- FIN DE LA CORRECCIÓN --- */
        }

        /* --- VISTA MÓVIL --- */
        @media (max-width: 899px) { /* Ligeramente ajustado para no solapar con la regla de 900px */
            .top-bar { display: none; } 
        }

        @media (max-width: 600px) {
            .page-container { padding: 1.5rem 1rem; }
            .profile-header h1 { font-size: 1.5rem; }
            .profile-header p { font-size: 1rem; }
            .bento-box { padding: 1.5rem; }
            .bento-grid { gap: 1rem; }
        }
    </style>
</head>
<body>
    <header class="top-bar">
        <div class="top-bar__left">
            <a href="/" class="top-bar__logo"><img src="https://i.ibb.co/hFRyKrxY/logo-epist-v3-1x1-c.png" alt="Logo Epistecnología"></a>
        </div>
        <div class="top-bar__right">
            <button class="top-bar-btn" id="theme-switcher" title="Cambiar tema"><i class="fa-solid fa-moon"></i></button>
            <button class="top-bar-btn" id="logout-btn-header" title="Cerrar Sesión"><i class="fa-solid fa-right-from-bracket"></i></button>
            <a href="/inv/dashboard.html" id="user-avatar-header" title="Ir al Dashboard"></a>
        </div>
    </header>
    
    <div class="page-container">
        <div class="profile-content">
            <header class="profile-header">
                <h1>Tu Centro de Control</h1>
                <p>Gestiona tu perfil público y tus proyectos de investigación desde un solo lugar.</p>
            </header>

            <div class="bento-grid">
                <div class="bento-box profile-card">
                    <div class="profile-card__avatar-wrapper"><img id="profile-card-avatar" alt="Avatar de usuario"></div>
                    <h2 id="profile-card-name">Cargando...</h2>
                    <p id="profile-card-bio"></p>
                    <div id="profile-card-social-links" class="social-links"></div>
                    <div class="dashboard-link-wrapper">
                        <a href="/inv/dashboard.html" id="dashboard-link-btn" class="btn-primary is-disabled"><i class="fa-solid fa-arrow-right"></i> Acceder al Dashboard</a>
                    </div>
                </div>

                <div class="bento-box profile-form-container">
                    <h3><i class="fa-solid fa-user-pen"></i> Editar Información Pública</h3>
                    <form id="profile-form">
                        <div class="form-group">
                            <label for="orcid-id">ORCID iD</label>
                            <div class="input-group">
                                <input type="text" id="orcid-id" placeholder="0000-0001-2345-6789" required>
                                <button type="button" id="validate-orcid-btn" class="btn-secondary">Validar</button>
                            </div>
                        </div>
                        <div class="form-group"><label for="display-name">Nombre a Mostrar</label><input type="text" id="display-name" required></div>
                        <div class="form-group"><label for="bio">Biografía Corta</label><textarea id="bio" rows="3" maxlength="250"></textarea></div>
                        
                        <hr>
                        <h3><i class="fa-solid fa-share-nodes"></i> Redes Sociales</h3>
                        <div class="form-group"><label for="website-url">Sitio Web / Blog</label><input type="url" id="website-url" placeholder="https://..."></div>
                        <div class="form-group"><label for="x-url">Perfil de X (Twitter)</label><input type="url" id="x-url" placeholder="https://x.com/usuario"></div>
                        <div class="form-group"><label for="linkedin-url">Perfil de LinkedIn</label><input type="url" id="linkedin-url" placeholder="https://linkedin.com/in/usuario"></div>
                        <div class="form-group"><label for="instagram-url">Perfil de Instagram</label><input type="url" id="instagram-url" placeholder="https://instagram.com/usuario"></div>

                        <button type="submit" class="btn-primary"><i class="fa-solid fa-floppy-disk"></i> <span class="btn-text">Guardar Cambios</span></button>
                        <p id="profile-form-message" class="form-message"></p>
                    </form>
                </div>

                <div class="bento-box profile-projects-container">
                    <h3><i class="fa-solid fa-book-bookmark"></i> Mis Proyectos</h3>
                    <div id="projects-list"><p>Cargando proyectos...</p></div>
                    <button class="btn-secondary" id="add-project-btn" style="width: 100%; margin-top: 1rem;"><i class="fa-solid fa-plus"></i> Registrar Nuevo Proyecto</button>
                </div>
            </div>
        </div>
    </div>
    <div id="project-modal-overlay" class="modal-overlay"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        // El código JavaScript no ha cambiado y permanece igual que en la versión anterior.
        // ... (todo tu bloque de script type="module" va aquí sin cambios) ...
        const { createClient } = window.supabase;
        const SUPABASE_URL = 'https://seyknzlheaxmwztkfxmk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNleWtuemxoZWF4bXd6dGtmeG1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyNjc5MTQsImV4cCI6MjA2NDg0MzkxNH0.waUUTIWH_p6wqlYVmh40s4ztG84KBPM_Ut4OFF6WC4E';
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener('DOMContentLoaded', async () => {
            const themeSwitcher = document.getElementById('theme-switcher');
            const applyTheme = (theme) => {
                document.body.classList.toggle("dark-theme", theme === "dark");
                themeSwitcher.querySelector('i').className = `fa-solid ${theme === "dark" ? "fa-sun" : "fa-moon"}`;
            };
            themeSwitcher.addEventListener("click", () => {
                const newTheme = document.body.classList.contains("dark-theme") ? "light" : "dark";
                localStorage.setItem("theme", newTheme);
                applyTheme(newTheme);
            });
            applyTheme(localStorage.getItem('theme') || 'light');

            document.getElementById('logout-btn-header')?.addEventListener('click', () => supabaseClient.auth.signOut());

            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) { 
                window.location.href = '/'; 
                return;
            }
            
            const userId = session.user.id;
            const userMetadata = session.user.user_metadata;
            
            Profile.init(userId, userMetadata);
            Projects.init(userId);
        });

        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT' || !session) {
                window.location.href = '/';
            }
        });

        const Profile = {
            isOrcidValidated: false, 
            async init(userId, userMetadata) {
                this.userId = userId;
                this.userMetadata = userMetadata;
                this.form = document.getElementById('profile-form');
                this.loadData();
                this.form.addEventListener('submit', (e) => this.handleSave(e));
                document.getElementById('validate-orcid-btn').addEventListener('click', () => this.handleValidateOrcid());
            },
            checkDashboardLink(profileData) {
                const dashboardLink = document.getElementById('dashboard-link-btn');
                const hasProjects = profileData?.projects && profileData.projects.length > 0;
                
                if (this.isOrcidValidated && hasProjects) {
                    dashboardLink.classList.remove('is-disabled');
                    dashboardLink.title = "¡Listo! Accede al dashboard.";
                } else {
                    dashboardLink.classList.add('is-disabled');
                    dashboardLink.title = "Debes validar un ORCID y tener al menos un proyecto para continuar.";
                }
            },
            async loadData() {
                const avatarUrl = this.userMetadata?.avatar_url || 'https://i.ibb.co/61fJv24/default-avatar.png';
                document.getElementById('profile-card-avatar').src = avatarUrl;
                document.getElementById('user-avatar-header').innerHTML = `<img src="${avatarUrl}" alt="Avatar">`;

                const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', this.userId).single();
                if (error && error.code !== 'PGRST116') return console.error(error);
                
                if (data) {
                    document.getElementById('profile-card-name').textContent = data.display_name || this.userMetadata?.full_name || 'Nombre no definido';
                    document.getElementById('profile-card-bio').textContent = data.bio || '';
                    this.form.querySelector('#display-name').value = data.display_name || '';
                    this.form.querySelector('#bio').value = data.bio || '';
                    this.form.querySelector('#orcid-id').value = data.orcid ? data.orcid.split('/').pop() : '';
                    this.form.querySelector('#website-url').value = data.website_url || '';
                    this.form.querySelector('#x-url').value = data.x_url || '';
                    this.form.querySelector('#linkedin-url').value = data.linkedin_url || '';
                    this.form.querySelector('#instagram-url').value = data.instagram_url || '';
                    
                    const socialContainer = document.getElementById('profile-card-social-links');
                    socialContainer.innerHTML = `
                        ${data.website_url ? `<a href="${data.website_url}" target="_blank" title="Sitio Web"><i class="fas fa-globe"></i></a>` : ''}
                        ${data.x_url ? `<a href="${data.x_url}" target="_blank" title="Perfil de X"><i class="fa-brands fa-x-twitter"></i></a>` : ''}
                        ${data.linkedin_url ? `<a href="${data.linkedin_url}" target="_blank" title="Perfil de LinkedIn"><i class="fab fa-linkedin"></i></a>` : ''}
                        ${data.instagram_url ? `<a href="${data.instagram_url}" target="_blank" title="Perfil de Instagram"><i class="fab fa-instagram"></i></a>` : ''}
                    `;
                    
                    if (data.orcid) this.isOrcidValidated = true; 
                }
                this.checkDashboardLink(data);
            },
            
            async handleValidateOrcid() {
                const orcidInput = document.getElementById('orcid-id');
                const orcidId = orcidInput.value.trim();
                const messageEl = document.getElementById('profile-form-message');
                const validateBtn = document.getElementById('validate-orcid-btn');
                
                const orcidRegex = /^\d{4}-\d{4}-\d{4}-\d{3}[\dX]$/;
                if (!orcidRegex.test(orcidId)) {
                    messageEl.textContent = 'El formato del ORCID iD no es válido (ej: 0000-0001-2345-6789).';
                    messageEl.className = 'form-message error';
                    return;
                }
                
                validateBtn.textContent = 'Validando...';
                validateBtn.disabled = true;
                
                try {
                    const response = await fetch(`https://pub.orcid.org/v3.0/${orcidId}`, {
                        headers: { 'Accept': 'application/json' }
                    });

                    if (!response.ok) throw new Error('ORCID iD no encontrado o no es público.');
                    
                    const data = await response.json();
                    
                    const person = data.person;
                    const givenName = person.name['given-names']?.value || '';
                    const familyName = person.name['family-name']?.value || '';
                    document.getElementById('display-name').value = `${givenName} ${familyName}`.trim();
                    
                    const bioText = data['activities-summary']?.employments?.['employment-summary']?.[0]?.['organization']?.name || 
                                    data['activities-summary']?.educations?.['affiliation-group']?.[0]?.summaries?.[0]?.['education-summary']?.organization?.name || '';
                    document.getElementById('bio').value = bioText;
                    
                    this.isOrcidValidated = true;
                    messageEl.textContent = `¡ORCID validado para ${givenName} ${familyName}!`;
                    messageEl.className = 'form-message success';
                    this.checkDashboardLink({ orcid: orcidId, projects: Projects.projects });
                    
                } catch(error) {
                    this.isOrcidValidated = false;
                    messageEl.textContent = error.message;
                    messageEl.className = 'form-message error';
                } finally {
                    validateBtn.textContent = 'Validar';
                    validateBtn.disabled = false;
                }
            },

            async handleSave(e) {
                e.preventDefault();
                if (!this.isOrcidValidated) {
                    document.getElementById('profile-form-message').textContent = 'Por favor, valida tu ORCID iD antes de guardar.';
                    document.getElementById('profile-form-message').className = 'form-message error';
                    return;
                }
                
                const saveButton = this.form.querySelector('button[type="submit"]');
                const btnText = saveButton.querySelector('.btn-text');
                const messageEl = document.getElementById('profile-form-message');
                
                saveButton.disabled = true; 
                btnText.textContent = 'Guardando...';
                
                const orcidId = this.form.querySelector('#orcid-id').value.trim();

                const updates = { 
                    id: this.userId, 
                    updated_at: new Date(), 
                    display_name: this.form.querySelector('#display-name').value, 
                    bio: this.form.querySelector('#bio').value, 
                    orcid: `https://orcid.org/${orcidId}`,
                    website_url: this.form.querySelector('#website-url').value,
                    x_url: this.form.querySelector('#x-url').value,
                    linkedin_url: this.form.querySelector('#linkedin-url').value,
                    instagram_url: this.form.querySelector('#instagram-url').value,
                };
                
                const { error } = await supabaseClient.from('profiles').upsert(updates);
                
                messageEl.textContent = error ? error.message : '¡Cambios guardados con éxito!';
                messageEl.className = `form-message ${error ? 'error' : 'success'}`;
                if (!error) this.loadData();

                setTimeout(() => {
                    saveButton.disabled = false; 
                    btnText.textContent = 'Guardar Cambios';
                    messageEl.textContent = ''; 
                    messageEl.className = 'form-message';
                }, 3000);
            },
        };

        const Projects = {
            projects: [], 
            fetchedProjectData: null,
            init(userId) {
                this.userId = userId;
                document.getElementById('add-project-btn').addEventListener('click', () => this.openModal());
                this.loadProjects();
            },
            async loadProjects() {
                const { data } = await supabaseClient.from('profiles').select('projects').eq('id', this.userId).single();
                this.projects = data?.projects || []; 
                const listEl = document.getElementById('projects-list');
                listEl.innerHTML = '';
                if (this.projects.length > 0) {
                    this.projects.forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'project-item';
                        item.innerHTML = `<p style="margin:0; font-weight: 500;">${p.title}</p><span style="font-size: 0.9em; color: var(--color-text-secondary);">DOI: ${p.doi}</span>`;
                        listEl.appendChild(item);
                    });
                } else {
                    listEl.innerHTML = '<p>Aún no has registrado ningún proyecto.</p>';
                }
                Profile.checkDashboardLink({ projects: this.projects });
            },
            openModal() {
                const modalOverlay = document.getElementById('project-modal-overlay');
                modalOverlay.innerHTML = `
                    <div class="modal">
                        <header class="modal-header"><h2>Registrar Proyecto por DOI</h2><button class="modal-close-btn">&times;</button></header>
                        <main class="modal-content">
                            <p>Pega el DOI de tu publicación para buscar los metadatos.</p>
                            <div class="doi-fetcher"><input type="text" id="doi-input" placeholder="10.5281/zenodo.12345"><button id="fetch-doi-btn" class="btn-secondary">Buscar</button></div>
                            <div id="doi-fetch-status" class="form-message"></div><hr>
                            <div class="form-group"><label>Título</label><input type="text" id="project-title" disabled></div>
                            <div class="form-group"><label>Autores</label><input type="text" id="project-authors" disabled></div>
                        </main>
                        <footer class="modal-footer"><button id="save-project-btn" class="btn-primary" disabled><i class="fa-solid fa-floppy-disk"></i> Guardar Proyecto</button></footer>
                    </div>`;
                modalOverlay.classList.add('is-visible');
                modalOverlay.querySelector('.modal-close-btn').addEventListener('click', () => this.closeModal());
                modalOverlay.querySelector('#fetch-doi-btn').addEventListener('click', () => this.handleFetchDoi());
                modalOverlay.querySelector('#save-project-btn').addEventListener('click', () => this.handleSaveProject());
            },
            closeModal() { 
                const modalOverlay = document.getElementById('project-modal-overlay');
                modalOverlay.classList.remove('is-visible');
                modalOverlay.innerHTML = '';
            },
            async handleFetchDoi() {
                const doiInput = document.getElementById('doi-input');
                const statusDiv = document.getElementById('doi-fetch-status');
                const fetchBtn = document.getElementById('fetch-doi-btn');
                statusDiv.textContent = 'Buscando...'; statusDiv.className = 'form-message';
                fetchBtn.disabled = true;
                
                try {
                    const response = await fetch(`https://api.datacite.org/dois/${doiInput.value.trim()}`);
                    if (!response.ok) throw new Error('DOI no encontrado o inválido.');
                    const data = await response.json();
                    const metadata = data.data.attributes;
                    document.getElementById('project-title').value = metadata.titles[0]?.title || 'N/A';
                    document.getElementById('project-authors').value = metadata.creators.map(c => c.name).join(', ');
                    this.fetchedProjectData = { doi: doiInput.value, title: metadata.titles[0]?.title, authors: metadata.creators.map(c => c.name) };
                    document.getElementById('save-project-btn').disabled = false;
                    statusDiv.textContent = '¡Metadatos encontrados!'; statusDiv.className = 'form-message success';
                } catch(error) {
                    statusDiv.textContent = error.message;
                    messageEl.className = 'form-message error';
                } finally {
                    fetchBtn.disabled = false;
                }
            },
            async handleSaveProject() {
                if (!this.fetchedProjectData) return;
                const saveBtn = document.getElementById('save-project-btn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Guardando...';

                const { data: profile } = await supabaseClient.from('profiles').select('projects').eq('id', this.userId).single();
                const existingProjects = profile?.projects || [];
                
                if (existingProjects.some(p => p.doi === this.fetchedProjectData.doi)) {
                    alert("Este proyecto (DOI) ya ha sido registrado.");
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Guardar Proyecto';
                    return;
                }

                const newProjects = [...existingProjects, this.fetchedProjectData];
                const { error } = await supabaseClient.from('profiles').update({ projects: newProjects }).eq('id', this.userId);
                if (error) { 
                    alert("Error al guardar el proyecto."); 
                    console.error(error);
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Guardar Proyecto';
                } else { 
                    this.loadProjects(); 
                    this.closeModal(); 
                }
            }
        };
    </script>
</body>
</html>