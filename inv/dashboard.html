<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Epistecnología</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/hFRyKrxY/logo-epist-v3-1x1-c.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="/inv/css/dashboard.css">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/" class="logo-link"><img src="https://i.ibb.co/hFRyKrxY/logo-epist-v3-1x1-c.png" alt="Logo" class="logo"></a>
                <h2 class="link-text">Dashboard</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-link active" data-section="home-section" title="Inicio"><i class="fa-solid fa-table-columns"></i><span class="link-text">Dashboard</span></a>                
                <a href="#" class="nav-link" data-section="studio-section" title="Sesiones de divulgación"><i class="fa-solid fa-podcast"></i><span class="link-text">Sesiones</span></a>
                <a href="#" class="nav-link" data-section="editor-section" title="Editor" style="display: none;"><i class="fa-solid fa-pencil"></i><span class="link-text">Editor</span></a>
                <a href="#" class="nav-link" data-section="events-section" title="Gestionar Eventos"><i class="fa-solid fa-calendar-days"></i><span class="link-text">Eventos</span></a>
                <a href="#" class="nav-link" data-section="content-section" title="Gestionar Contenido" style="display: none;"><i class="fas fa-photo-film"></i><span class="link-text">Gestionar Contenido</span></a>
                <a href="/inv/profile.html" class="nav-link" title="Mi Perfil"><i class="fa-solid fa-user-edit"></i><span class="link-text">Mi Perfil</span></a>
                <a href="#" class="nav-link admin-only" data-section="community-section" title="Gestión de Comunidad" style="display: none;">
                    <i class="fa-solid fa-users-gear"></i>
                    <span class="link-text">Comunidad</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <button id="logout-btn" class="nav-link" title="Cerrar Sesión"><i class="fa-solid fa-right-from-bracket"></i><span class="link-text">Cerrar Sesión</span></button>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <h1 id="user-name-header">Cargando...</h1>
                <div id="bsky-status-banner" class="status-banner is-loading">
                    <p>Verificando conexión con Bluesky...</p>
                </div>
                <div class="header-actions">
                    <button class="btn-secondary" id="theme-switcher-dashboard" title="Cambiar tema">
                        <i class="fa-solid fa-moon"></i>
                    </button>
                </div>
            </header>
            
            <section id="home-section" class="content-section active"></section>
            <section id="studio-section" class="content-section"></section>
            <section id="events-section" class="content-section"></section>
            <section id="content-section" class="content-section"></section>
        </main>
    </div>

    <div id="modal-overlay-container"></div>

    <template id="template-home-section">
        <div class="workflow-step">
            <h2><span class="step-number">1</span> Selecciona tu Proyecto</h2>
            <p>Elige un proyecto para asociarlo a tu próxima creación de contenido.</p>
            <div id="projects-list-container"></div>
        </div>
        
        <div class="workflow-step">
            <h2><span class="step-number">2</span> ¿Cómo quieres divulgar hoy?</h2>
            <p>Elige una herramienta para empezar (necesitas seleccionar un proyecto primero).</p>
            
            <div class="creation-grid">

                <h4 class="creation-grid-subtitle">Transmitir o Grabar</h4>
                
                <div class="creation-card disabled" data-studio-action="live">
                    <i class="fa-solid fa-tower-broadcast icon"></i>
                    <h3>Transmitir en Vivo</h3>
                    <p>Genera una sala y un enlace público para tu audiencia.</p>
                </div>
                
                <div class="creation-card disabled" data-studio-action="podcast">
                    <i class="fa-solid fa-microphone-lines icon"></i>
                    <h3>Grabar Podcast</h3>
                    <p>Crea una sala de solo audio de alta calidad.</p>
                </div>
                
                <div class="creation-card disabled" data-studio-action="presentation">
                    <i class="fa-solid fa-desktop icon"></i>
                    <h3>Grabar Presentación</h3>
                    <p>Grábate a ti mismo junto a tu pantalla o diapositivas.</p>
                </div>
                
                <div class="creation-card disabled" data-studio-action="interview">
                    <i class="fa-solid fa-users icon"></i>
                    <h3>Grabar Entrevista</h3>
                    <p>Una sala de video para conversar con invitados.</p>
                </div>

                <h4 class="creation-grid-subtitle">Crear con Asistencia de IA</h4>
                
                <div class="creation-card disabled" data-studio-action="text">
                    <i class="fa-solid fa-file-lines icon"></i>
                    <h3>Artículo / Post</h3>
                    <p>Redacta publicaciones para tu blog, newsletter o prensa.</p>
                </div>
                
                <div class="creation-card disabled" data-studio-action="social">
                    <i class="fa-solid fa-hashtag icon"></i>
                    <h3>Post para Redes</h3>
                    <p>Genera textos cortos y efectivos para tus redes sociales.</p>
                </div>

                <div class="creation-card disabled" data-studio-action="script">
                    <i class="fa-solid fa-scroll icon"></i>
                    <h3>Crear Guion</h3>
                    <p>Desarrolla guiones para videos, conferencias o podcasts.</p>
                </div>

                <div class="creation-card disabled" data-studio-action="image">
                    <i class="fa-solid fa-image icon"></i>
                    <h3>Generar Imagen</h3>
                    <p>Crea imágenes únicas para tus publicaciones con IA.</p>
                </div>
            </div>
        </div>

        <div class="workflow-step">
            <h2><span class="step-number">3</span> Expande tu Alcance</h2>
            <p>Genera una página pública profesional para tu proyecto con un solo clic.</p>
            
            <div class="creation-grid">
                <div class="creation-card disabled" data-studio-action="microsite">
                    <i class="fa-solid fa-satellite-dish icon"></i>
                    <h3>Microsite del Proyecto</h3>
                    <p>Crea una landing page para centralizar y compartir tu investigación.</p>
                </div>
            </div>
        </div>

    </template>
    
    <template id="template-studio-section">
        <div class="page-header">
            <h2><i class="fas fa-podcast"></i> Sesiones de divulgación</h2>
            <p>Gestiona tus sesiones agendadas y revisa la programación de la plataforma.</p>
        </div>
        <div class="studio-tabs">
            <button class="studio-tab-link active" data-tab="my-sessions-tab">Mis Sesiones</button>
            <button class="studio-tab-link" data-tab="global-schedule-tab">Agenda Global</button>
        </div>
        <div class="studio-tab-content-wrapper">
            <div id="my-sessions-tab" class="studio-tab-content active">
                <div id="sessions-container" class="sessions-grid"></div>
            </div>
            <div id="global-schedule-tab" class="studio-tab-content">
                <div id="global-schedule-container" class="sessions-grid"></div>
            </div>
        </div>
    </template>

    <template id="template-content-section">
        <div class="page-header">
            <h2><i class="fas fa-photo-film"></i> Gestión de Contenido</h2>
            <p>Añade o elimina los videos On-Demand y Shorts que se muestran en la página pública.</p>
        </div>
        <div class="content-management-layout">
            <div class="content-column">
                <h3>Videos On-Demand</h3>
                <form id="add-ondemand-form" class="add-content-form">
                    <input type="text" name="title" placeholder="Título del video" required>
                    <input type="text" name="youtube_video_id" placeholder="ID del video de YouTube" required>
                    <button type="submit" class="btn-secondary">Añadir Video</button>
                </form>
                <div id="ondemand-list-container" class="video-list"></div>
            </div>
            <div class="content-column">
                <h3>Shorts</h3>
                <form id="add-short-form" class="add-content-form">
                    <input type="text" name="youtube_video_id" placeholder="ID del Short de YouTube" required>
                    <button type="submit" class="btn-secondary">Añadir Short</button>
                </form>
                <div id="shorts-list-container" class="video-list"></div>
            </div>
        </div>
    </template>

    <template id="template-editor-section">
        <div class="page-header">
            <h1><i class="fa-solid fa-pen-to-square"></i> Estudio de Creación de Contenido</h1>
            <p>Utiliza el asistente de IA para redactar, resumir y mejorar tus publicaciones.</p>
        </div>
        
        <div class="editor-layout">
            <div class="editor-main">
                <div class="form-group">
                    <input type="text" id="post-title" placeholder="Escribe un título atractivo...">
                </div>
                <div class="form-group">
                    <textarea id="rich-text-editor"></textarea>
                </div>
            </div>
            <aside class="editor-sidebar">
                <div class="bento-box instructions-box">
                    <h3><i class="fa-solid fa-circle-info"></i> ¿Cómo Empezar?</h3>
                    <p>1. Escribe o pega tu texto en el editor.</p>
                    <p>2. Usa el <strong>Asistente IA</strong> para refinarlo, sugerir títulos o crear resúmenes.</p>
                    <p>3. Guarda tu progreso con <strong>"Guardar Borrador"</strong>.</p>
                </div>
                <div class="bento-box">
                    <h3><i class="fa-solid fa-wand-magic-sparkles"></i> Asistente IA</h3>
                    <div class="form-group">
                        <label for="ai-custom-prompt">Instrucciones Adicionales (opcional):</label>
                        <textarea id="ai-custom-prompt" rows="3" placeholder="Ej: Tono formal, 500 palabras..."></textarea>
                    </div>
                    <div class="ai-actions">
                        <button id="ai-suggest-titles-btn" class="btn-secondary">Sugerir Títulos</button>
                        <button id="ai-create-summary-btn" class="btn-secondary">Crear Resumen</button>
                        <div id="ai-results"></div>
                    </div>
                </div>
                <div class="bento-box">
                    <h3><i class="fa-solid fa-cogs"></i> Acciones</h3>
                    <div class="publish-actions">
                    <button id="save-draft-btn" class="btn-secondary">Guardar Borrador</button>
                    <button class="btn-primary">Publicar</button>
                    </div>
                </div>
            </aside>
        </div>
    </template>

    <template id="template-events-section">
        <div class="page-header">
            <h2><i class="fa-solid fa-calendar-star"></i> Gestión de Eventos</h2>
            <p>Crea y administra las páginas para tus congresos, foros y seminarios.</p>
        </div>
        <div class="page-actions">
            <button id="create-event-btn" class="btn-primary">
                <i class="fa-solid fa-plus"></i> Crear Nuevo Evento
            </button>
        </div>
        <div id="events-list-container" class="events-grid">
            </div>
    </template>

    <template id="template-community-section">
        <div class="page-header">
            <h2><i class="fa-solid fa-users-viewfinder"></i> Gestión de Comunidad</h2>
            <p>Control Total: Edita perfiles, asigna ORCID manualmente y gestiona redes.</p>
        </div>

        <div class="filter-bar" style="margin-bottom: 2rem; background: var(--color-surface); padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);">
            <div class="search-container" style="position: relative; max-width: 600px;">
                <i class="fa-solid fa-search search-icon" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--color-text-secondary);"></i>
                <input type="text" id="admin-user-search" placeholder="Buscar investigador por nombre, email o username..." 
                    style="width: 100%; padding: 12px 12px 12px 45px; border-radius: 50px; border: 1px solid var(--color-border); font-size: 1rem; outline: none; transition: border 0.3s;">
            </div>
        </div>

        <div class="bento-grid" style="grid-template-columns: 1fr;">
            <div class="bento-box" style="padding: 0; overflow: hidden; border-radius: 12px;">
                <table class="data-table" style="width: 100%; border-collapse: collapse;">
                    <thead style="background: var(--color-background); border-bottom: 1px solid var(--color-border);">
                        <tr>
                            <th style="padding: 1rem; text-align: left;">Investigador</th>
                            <th style="padding: 1rem; text-align: left;">Rol</th>
                            <th style="padding: 1rem; text-align: left;">Linktree (@)</th>
                            <th style="padding: 1rem; text-align: right;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="admin-users-list">
                        <tr><td colspan="4" style="padding: 2rem; text-align: center;">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="admin-edit-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
            <div class="modal-content" style="background:var(--color-surface); border-radius:12px; width:90%; max-width:600px; max-height:90vh; display:flex; flex-direction:column; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
                
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--color-border); display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0;">Editar Perfil Público</h3>
                    <button onclick="document.getElementById('admin-edit-modal').style.display='none'" style="background:none; border:none; cursor:pointer; font-size:1.2rem;"><i class="fa-solid fa-times"></i></button>
                </div>

                <div style="padding: 1.5rem; overflow-y: auto; flex-grow: 1;">
                    <form id="admin-user-form" style="display:flex; flex-direction:column; gap:1.2rem;">
                        <input type="hidden" id="edit-user-id">
                        
                        <div style="display:grid; grid-template-columns: 100px 1fr; gap:1rem; align-items:start;">
                            <div style="text-align:center;">
                                <img id="preview-avatar" src="" style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:2px solid var(--color-border); background:#eee;">
                                <p style="font-size:0.7rem; color:#888; margin-top:5px;">Vista Previa</p>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:0.8rem;">
                                <div>
                                    <label style="font-size:0.85rem; font-weight:bold;">URL de Foto de Perfil (Avatar)</label>
                                    <input type="text" id="edit-avatar-url" class="form-input" placeholder="https://..." style="width:100%; padding:8px; border:1px solid var(--color-border); border-radius:6px;">
                                </div>
                                <div>
                                    <label style="font-size:0.85rem; font-weight:bold;">Nombre Completo</label>
                                    <input type="text" id="edit-display-name" class="form-input" style="width:100%; padding:8px; border:1px solid var(--color-border); border-radius:6px;">
                                </div>
                            </div>
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                            <div>
                                <label style="font-size:0.85rem; font-weight:bold;">Username (@)</label>
                                <input type="text" id="edit-username" placeholder="juanperez" style="width:100%; padding:8px; border:1px solid var(--color-border); border-radius:6px;">
                            </div>
                            <div>
                                <label style="font-size:0.85rem; font-weight:bold; color:#A6CE39;">ORCID iD (Manual)</label>
                                <input type="text" id="edit-orcid" placeholder="0000-0000-0000-0000" style="width:100%; padding:8px; border:1px solid #A6CE39; border-radius:6px;">
                            </div>
                        </div>

                        <div>
                            <label style="font-size:0.85rem; font-weight:bold;">Bio Corta (Slogan Linktree)</label>
                            <textarea id="edit-bio-short" rows="2" maxlength="150" style="width:100%; padding:8px; border:1px solid var(--color-border); border-radius:6px; resize:none;"></textarea>
                        </div>

                        <hr style="border:0; border-top:1px solid var(--color-border);">
                        <p style="font-size:0.85rem; font-weight:bold; color:var(--color-text-secondary); margin:0;">Redes Sociales y Enlaces</p>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                            <div><input type="text" id="edit-website" placeholder="Sitio Web (https://...)" class="form-input-social"></div>
                            <div><input type="text" id="edit-substack" placeholder="Substack URL" class="form-input-social"></div>
                            <div><input type="text" id="edit-linkedin" placeholder="LinkedIn URL" class="form-input-social"></div>
                            <div><input type="text" id="edit-x" placeholder="X / Twitter URL" class="form-input-social"></div>
                            <div><input type="text" id="edit-bluesky" placeholder="Bluesky URL" class="form-input-social"></div>
                            <div><input type="text" id="edit-instagram" placeholder="Instagram URL" class="form-input-social"></div>
                            <div><input type="text" id="edit-facebook" placeholder="Facebook URL" class="form-input-social"></div>
                            <div><input type="text" id="edit-youtube" placeholder="YouTube URL" class="form-input-social"></div>
                            <div><input type="text" id="edit-tiktok" placeholder="TikTok URL" class="form-input-social"></div>
                        </div>

                        <style>
                            .form-input-social { width:100%; padding:8px; border:1px solid var(--color-border); border-radius:6px; font-size:0.85rem; }
                            .form-input-social:focus { border-color: var(--color-accent); outline:none; }
                        </style>
                    </form>
                </div>

                <div style="padding: 1.5rem; border-top: 1px solid var(--color-border); text-align:right;">
                    <button type="submit" form="admin-user-form" class="btn-primary" style="padding: 10px 25px;">Guardar Todo</button>
                </div>
            </div>
        </div>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="/inv/js/dashboard-main.js"></script>
</body>
</html>